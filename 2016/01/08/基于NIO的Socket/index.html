<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>基于NIO的Socket | Qlm&#39;s Blog</title>
  <meta name="description" content="Java Programer" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Qlm's Blog">
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/11/常用正则表达式/">常用正则表达式</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/11/Markdown语法说明/">Markdown语法说明</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/09/数字签名/">数字签名</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/09/关于ThreadLocal对象/">关于ThreadLocal对象</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/09/Java-volatile-关键字/">Java volatile 关键字</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/08/基于NIO的Socket/">基于NIO的Socket</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/06/Nginx部署SSL证书/">Nginx部署SSL证书</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/05/关键业务系统的JVM启动参数推荐/">关键业务系统的JVM启动参数推荐</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/05/vim程序编辑器/">vim程序编辑器</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/28/使用NIO提升性能/">使用NIO提升性能</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/25/Java异常/">Java异常</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/24/JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解/">JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/24/JVM飙高排查脚本-结构分析/">JVM飙高排查脚本-结构分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/23/《Java并发编程实战》笔记/">《Java并发编程实战》笔记</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/22/JVM设置/">JVM设置</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/21/线程池ThreadPoolExecutor/">线程池ThreadPoolExecutor</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/21/Java并发包/">java并发包</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/21/Timer的缺陷/">Timer的缺陷</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Spring-技术内幕-IoC容器的实现/">Spring 技术内幕-IoC容器的实现</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Java-加密与解密的艺术/">Java 加密与解密的艺术</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Spring-in-action/">Spring in action</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Spring-配置头文件/">Spring 配置头文件</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/前端乱码/">前端乱码</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/能力值控制实现文档/">能力值控制实现文档</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Linux常用命令/">Linux常用命令</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Java开发常用Linux命令/">Java开发常用Linux命令</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/其他/">&nbsp;&nbsp;&nbsp;其他</a>
                                    <small>3</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/工作/">&nbsp;&nbsp;&nbsp;工作</a>
                                    <small>2</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/开发/">&nbsp;&nbsp;&nbsp;开发</a>
                                    <small>15</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/读书/">&nbsp;&nbsp;&nbsp;读书</a>
                                    <small>6</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Java/">&nbsp;&nbsp;&nbsp;Java</a>
                                    <small>18</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Linux/">&nbsp;&nbsp;&nbsp;Linux</a>
                                    <small>3</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Markdown/">&nbsp;&nbsp;&nbsp;Markdown</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Nginx/">&nbsp;&nbsp;&nbsp;Nginx</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/SSL/">&nbsp;&nbsp;&nbsp;SSL</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Spring/">&nbsp;&nbsp;&nbsp;Spring</a>
                                    <small>3</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/工作/">&nbsp;&nbsp;&nbsp;工作</a>
                                    <small>2</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/正则/">&nbsp;&nbsp;&nbsp;正则</a>
                                    <small>1</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <!--<li class="mp-pjax"><a class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a></li>-->
                    <li><a class="fa fa-github" href="https://github.com/pqpo" target="_blank">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2016/01/11/常用正则表达式/">常用正则表达式</a>
                
                    <a  data-pjax href="/2016/01/11/Markdown语法说明/">Markdown语法说明</a>
                
                    <a  data-pjax href="/2016/01/09/数字签名/">数字签名</a>
                
                    <a  data-pjax href="/2016/01/09/关于ThreadLocal对象/">关于ThreadLocal对象</a>
                
                    <a  data-pjax href="/2016/01/09/Java-volatile-关键字/">Java volatile 关键字</a>
                
                    <a  data-pjax href="/2016/01/08/基于NIO的Socket/">基于NIO的Socket</a>
                
                    <a  data-pjax href="/2016/01/06/Nginx部署SSL证书/">Nginx部署SSL证书</a>
                
                    <a  data-pjax href="/2016/01/05/关键业务系统的JVM启动参数推荐/">关键业务系统的JVM启动参数推荐</a>
                
                    <a  data-pjax href="/2016/01/05/vim程序编辑器/">vim程序编辑器</a>
                
                    <a  data-pjax href="/2015/12/28/使用NIO提升性能/">使用NIO提升性能</a>
                
                    <a  data-pjax href="/2015/12/25/Java异常/">Java异常</a>
                
                    <a  data-pjax href="/2015/12/24/JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解/">JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解</a>
                
                    <a  data-pjax href="/2015/12/24/JVM飙高排查脚本-结构分析/">JVM飙高排查脚本-结构分析</a>
                
                    <a  data-pjax href="/2015/12/23/《Java并发编程实战》笔记/">《Java并发编程实战》笔记</a>
                
                    <a  data-pjax href="/2015/12/22/JVM设置/">JVM设置</a>
                
                    <a  data-pjax href="/2015/12/21/线程池ThreadPoolExecutor/">线程池ThreadPoolExecutor</a>
                
                    <a  data-pjax href="/2015/12/21/Java并发包/">java并发包</a>
                
                    <a  data-pjax href="/2015/12/21/Timer的缺陷/">Timer的缺陷</a>
                
                    <a  data-pjax href="/2015/12/17/Spring-技术内幕-IoC容器的实现/">Spring 技术内幕-IoC容器的实现</a>
                
                    <a  data-pjax href="/2015/12/17/Java-加密与解密的艺术/">Java 加密与解密的艺术</a>
                
                    <a  data-pjax href="/2015/12/17/Spring-in-action/">Spring in action</a>
                
                    <a  data-pjax href="/2015/12/17/Spring-配置头文件/">Spring 配置头文件</a>
                
                    <a  data-pjax href="/2015/12/17/前端乱码/">前端乱码</a>
                
                    <a  data-pjax href="/2015/12/17/能力值控制实现文档/">能力值控制实现文档</a>
                
                    <a  data-pjax href="/2015/12/17/Linux常用命令/">Linux常用命令</a>
                
                    <a  data-pjax href="/2015/12/17/Java开发常用Linux命令/">Java开发常用Linux命令</a>
                
                
                    <a data-pjax href="/categories/其他/">&nbsp;&nbsp;其他</a>
                
                    <a data-pjax href="/categories/工作/">&nbsp;&nbsp;工作</a>
                
                    <a data-pjax href="/categories/开发/">&nbsp;&nbsp;开发</a>
                
                    <a data-pjax href="/categories/读书/">&nbsp;&nbsp;读书</a>
                
                
                    <a data-pjax href="/tags/Java/">&nbsp;&nbsp;Java</a>
                
                    <a data-pjax href="/tags/Linux/">&nbsp;&nbsp;Linux</a>
                
                    <a data-pjax href="/tags/Markdown/">&nbsp;&nbsp;Markdown</a>
                
                    <a data-pjax href="/tags/Nginx/">&nbsp;&nbsp;Nginx</a>
                
                    <a data-pjax href="/tags/SSL/">&nbsp;&nbsp;SSL</a>
                
                    <a data-pjax href="/tags/Spring/">&nbsp;&nbsp;Spring</a>
                
                    <a data-pjax href="/tags/工作/">&nbsp;&nbsp;工作</a>
                
                    <a data-pjax href="/tags/正则/">&nbsp;&nbsp;正则</a>
                
                <a data-pjax class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Qlm&#39;s Blog</a></li>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                      
                      <a data-pjax href='/tags/Java/' style='color:#D5D5D5'>Java</a>
                      
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">基于NIO的Socket</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2016-01-08T06:44:12.000Z"
                              itemprop="datePublished">2016-01-08</time>
                    </div>
    </span>

        <section class="post-content">
            <p>缓冲区及其操作是所有NIO的基础。<br>传统流IO是基于字节的，所有IO都被视为单个字节的移动；而NIO是基于块的，NIO的性能肯定优于流IO。其性能的提高主要要得益于其使用的结构更接近操作系统执行IO的方式：通道和缓冲器。我们可以把它想象成一个煤矿，通道是一个包含煤层（数据）的矿藏，而缓冲器则是派送到矿藏的卡车。卡车载满煤炭而归，我们再从卡车上获得煤炭。也就是说，我们并没有直接和通道交互；我们只是和缓冲器交互，并把缓冲器派送到通道。通道要么从缓冲器获得数据，要么向缓冲器发送数据。（这段比喻出自Java编程思想）<br>NIO的主要应用在高性能、高容量服务端应用程序，典型的有Apache Mina就是基于它的。<br>对于缓冲区的详细介绍见：<a href="https://qlm.pw/2015/12/28/%E4%BD%BF%E7%94%A8NIO%E6%8F%90%E5%8D%87%E6%80%A7%E8%83%BD/" target="_blank" rel="external">使用NIO提升性能</a>  </p>
<p><strong>基于NIO的socket主要涉及三大块：Channel，Selector，Buffer。</strong>  </p>
<p>传统Socket写法：<br>Server端:   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">200</span>);</span><br><span class="line"><span class="keyword">final</span> ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">554</span>);</span><br><span class="line"><span class="keyword">final</span> String charset = <span class="string">"utf-8"</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		<span class="keyword">final</span> Socket socket = serverSocket.accept();</span><br><span class="line">		executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream(),charset));</span><br><span class="line">					BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream(),charset));</span><br><span class="line">					StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">					<span class="keyword">for</span>(String line=reader.readLine();line!=<span class="keyword">null</span>;line = reader.readLine())&#123;</span><br><span class="line">						sb.append(line);</span><br><span class="line">					&#125;</span><br><span class="line">					writer.write(<span class="string">"response:"</span>);</span><br><span class="line">					writer.write(sb.toString());</span><br><span class="line">					writer.flush();</span><br><span class="line">					socket.shutdownOutput();</span><br><span class="line">					socket.close();</span><br><span class="line">				&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		e.printStackTrace();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client端：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Socket socket = <span class="keyword">new</span> Socket(<span class="string">"127.0.0.1"</span>, <span class="number">554</span>);</span><br><span class="line">socket.setSoTimeout(<span class="number">5000</span>);</span><br><span class="line">String charset = <span class="string">"utf-8"</span>;</span><br><span class="line">BufferedWriter writer = <span class="keyword">new</span> BufferedWriter(<span class="keyword">new</span> OutputStreamWriter(socket.getOutputStream(),charset ));</span><br><span class="line">BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(socket.getInputStream(),charset));</span><br><span class="line">writer.write(<span class="string">"hello \r\nworld! 你好"</span>);</span><br><span class="line">writer.flush();</span><br><span class="line">socket.shutdownOutput();</span><br><span class="line">StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"><span class="keyword">for</span>(String line=reader.readLine();line!=<span class="keyword">null</span>;line = reader.readLine())&#123;</span><br><span class="line">	sb.append(line);</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(sb.toString());</span><br><span class="line">writer.close();</span><br><span class="line">reader.close();</span><br><span class="line">socket.close();</span><br></pre></td></tr></table></figure>
<h3 id="u5173_u4E8ESocket_u901A_u9053Channel"><a href="#u5173_u4E8ESocket_u901A_u9053Channel" class="headerlink" title="关于Socket通道Channel"></a>关于Socket通道Channel</h3><p>Socket通道有三个，分别是ServerSocketChannel、SocketChannel和DatagramChannel，而它们又分别对 应java.net包中的Socket对象ServerSocket、Socket和DatagramSocket；<strong><em>Socket通道被实例化时，都会创建一个对等的Socket对象。</em></strong><br>Socket通道可以运行非阻塞模式并且是可选择的，非阻塞I/O与可选择性是紧密相连的，这也正是管理阻塞的API要在 SelectableChannel中定义的原因。设置非阻塞非常简单，只要调用configureBlocking(false)方法即可。如果需要中途更改阻塞模式，那么必须首先获得blockingLock()方法返回的对象的锁。   </p>
<ul>
<li>ServerSocketChannel<br>ServerSocketChannel是一个基于通道的socket监听器。但它没有bind()方法，因此需要取出对等的Socket对象并使用它来绑定到某一端口以开始监听连接。在非阻塞模式下，当没有传入连接在等待时，其accept()方法会立即返回null。正是这种检查连接而不阻塞的能力实 现了可伸缩性并降低了复杂性，选择性也因此得以实现。</li>
<li>SocketChannel<br>相对于ServerSocketChannel，它扮演客户端，发起到监听服务器的连接，连接成功后，开始接收数据。<br>要注意的是，调用它的open()方法仅仅是打开但并未连接，要建立连接需要紧接着调用connect()方法；也可以两步合为一步，调用open(SocketAddress remote)方法。<br>你会发现connect()方法并未提供timout参数，作为替代方案，你可以用isConnected()、isConnectPending()或finishConnect()方法来检查连接状态。 </li>
<li>DatagramChannel<br>不同于前面两个通道对象，它是无连接的，它既可以作为服务器，也可以作为客户端。 </li>
</ul>
<h3 id="u5173_u4E8ESelector"><a href="#u5173_u4E8ESelector" class="headerlink" title="关于Selector"></a>关于Selector</h3><p>Selector（选择器）是Java NIO中能够检测一到多个NIO通道，并能够知晓通道是否为诸如读写事件做好准备的组件。这样，一个单独的线程可以管理多个channel，从而管理多个网络连接。选择器可谓NIO中的重头戏，I/O复用的核心。如果在阻塞模式下注册一个通道，系统会抛出IllegalBlockingModeException异常。 </p>
<p>创建一个Selector：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Selector selector = Selector.open();</span><br></pre></td></tr></table></figure>
<p>注册通道：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chanel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">SelectionKey key = channel.register(selector,SelectionKey.OP_ACCEPT);</span><br></pre></td></tr></table></figure>
<p>通过SelectionKey对象来联系通道和选择器，可以分别通过selectionKey.channel(),selectionKey.selector()获取，channel.register()的第二个参数用于监听关心系的操作，可以通过selectionKey.interestOps()获取。selectionKey.readyOps()可以得到通道已经准备好的操作。另外ready集合是interest集合的子集。  </p>
<p>选择键类中定义了4种可选择操作：read、write、 connect和accept：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SelectionKey.OP_CONNECT</span><br><span class="line">SelectionKey.OP_ACCEPT</span><br><span class="line">SelectionKey.OP_READ</span><br><span class="line">SelectionKey.OP_WRITE</span><br></pre></td></tr></table></figure>
<p>每个可选择通道都有一个validOps()的抽象方法，每个具体通道各自有不同的有效的可选择操作集 合，比如<strong><em>ServerSocketChannel的有效操作集合是accept，而SocketChannel的有效操作集合是read、write和 connect</em></strong>。  </p>
<p>在选择过程中，所关心的通道操作可以由方法 interestOps(int operations)进行修改，但不影响此次选择过程（在下一次选择过程中生效）。    </p>
<p>一个Selector实例有3个SelectionKey的集合：</p>
<ul>
<li><p>所有SelectionKey集合：代表了注册在该Selector上的Channel，这个集合可以通过keys()方法返回。</p>
</li>
<li><p>被选择的SelectionKey集合：代表了所有可通过select()方法监测到、需要进行IO处理的Channel，这个集合可以通过selectedKeys()返回。</p>
</li>
<li><p>被取消的SelectionKey集合：代表了所有被取消注册关系的Channel，在下一次执行select()方法时，这些Channel对应的SelectionKey会被彻底删除，程序通常无须直接访问该集合。</p>
</li>
</ul>
<p>SelectionKey中还可以添加附加对象，这样就能方便的识别某个给定的通道。例如，可以附加与通道一起使用的Buffer，或是包含聚集数据的某个对象。<br>使用方法如下：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">selectionKey.attach(theObject);</span><br><span class="line">Object attachedObj = selectionKey.attachment();</span><br></pre></td></tr></table></figure>
<p>还可以在用register()方法向Selector注册Channel的时候附加对象。如：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SelectionKey key = channel.register(selector, SelectionKey.OP_READ, theObject);</span><br></pre></td></tr></table></figure>
<h3 id="u901A_u8FC7Selector_u9009_u62E9_u901A_u9053"><a href="#u901A_u8FC7Selector_u9009_u62E9_u901A_u9053" class="headerlink" title="通过Selector选择通道"></a>通过Selector选择通道</h3><p>一旦向Selector注册了一或多个通道，就可以调用几个重载的select()方法。这些方法返回你所感兴趣的事件（如连接、接受、读或写）已经准备就绪的那些通道。换句话说，如果你对“读就绪”的通道感兴趣，select()方法会返回读事件已经就绪的那些通道。  </p>
<p>下面是select()方法：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">()</span></span><br><span class="line"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">long</span> timeout)</span></span><br><span class="line"><span class="keyword">int</span> <span class="title">selectNow</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>select()阻塞到至少有一个通道在你注册的事件上就绪了。<br>select(long timeout)和select()一样，除了最长会阻塞timeout毫秒(参数)。<br>selectNow()不会阻塞，不管什么通道就绪都立刻返回。  </p>
<p>select()方法返回的int值表示有多少通道已经就绪。亦即，自上次调用select()方法后有多少通道变成就绪状态。如果调用select()方法，因为有一个通道变成就绪状态，返回了1，若再次调用select()方法，如果另一个通道就绪了，它会再次返回1。如果对第一个就绪的channel没有做任何操作，现在就有两个就绪的通道，但在每次select()方法调用之间，只有一个通道就绪了。   </p>
<p>一旦调用了select()方法，并且返回值表明有一个或更多个通道就绪了，然后可以通过调用selector的selectedKeys()方法，访问“已选择键集（selected key set）”中的就绪通道。如下所示： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set selectedKeys = selector.selectedKeys();</span><br></pre></td></tr></table></figure>
<p>当Selector注册Channel时，Channel.register()方法会返回一个SelectionKey 对象。这个对象代表了注册到该Selector的通道。可以通过SelectionKey的selectedKeySet()方法访问这些对象。  </p>
<p>每次迭代SelectedKeySet，需要调用remove();Selector不会自己从已选择键集中移除SelectionKey实例。必须在处理完通道时自己移除。下次该通道变成就绪时，Selector会再次将其放入已选择键集中。  </p>
<p>在以下情况下，SelectionKey对象会失效，这意味着Selector再也不会监控与它相关的事件：  </p>
<ul>
<li>程序调用SelectionKey的cancel()方法</li>
<li>关闭与SelectionKey关联的Channel</li>
<li>与SelectionKey关联的Selector被关闭</li>
</ul>
<p>基于NIO的Socket：<br>Server端：  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();</span><br><span class="line">serverSocketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">ServerSocket serverSocket = serverSocketChannel.socket();</span><br><span class="line">serverSocket.bind(<span class="keyword">new</span> InetSocketAddress(<span class="number">2223</span>));</span><br><span class="line">		</span><br><span class="line">Selector selector = Selector.open();</span><br><span class="line">serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT, <span class="keyword">null</span>);</span><br><span class="line">System.out.println(<span class="string">"started..."</span>);</span><br><span class="line">		</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">	<span class="keyword">int</span> readyChannel = selector.select();</span><br><span class="line">	<span class="keyword">if</span>(readyChannel&lt;=<span class="number">0</span>) <span class="keyword">continue</span>;</span><br><span class="line">	Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">	Iterator&lt;SelectionKey&gt; it = selectedKeys.iterator();</span><br><span class="line">	<span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">		SelectionKey selectionKey = it.next();</span><br><span class="line">		<span class="keyword">if</span>(selectionKey.isAcceptable())&#123;</span><br><span class="line">			ServerSocketChannel ssc =  (ServerSocketChannel) selectionKey.channel();</span><br><span class="line">			SocketChannel sc = ssc.accept();</span><br><span class="line">			sc.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">			sc.register(selector, SelectionKey.OP_READ, <span class="keyword">null</span>);</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(selectionKey.isReadable())&#123;</span><br><span class="line">			SocketChannel sc = (SocketChannel) selectionKey.channel();</span><br><span class="line">			ByteBuffer byteBuffer = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">			StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">				byteBuffer.clear();</span><br><span class="line">				<span class="keyword">if</span>(sc.read(byteBuffer)&lt;=<span class="number">0</span>)<span class="keyword">break</span>;</span><br><span class="line">				byteBuffer.flip();</span><br><span class="line">				<span class="keyword">while</span>(byteBuffer.hasRemaining())&#123;</span><br><span class="line">					sb.append(byteBuffer.get());</span><br><span class="line">				&#125;</span><br><span class="line">				byteBuffer.rewind();</span><br><span class="line">				sc.write(byteBuffer);</span><br><span class="line">			&#125;</span><br><span class="line">			System.out.println(<span class="string">"request:"</span>+sb.toString());</span><br><span class="line">			selectionKey.cancel();</span><br><span class="line">		&#125;</span><br><span class="line"><span class="comment">//		if(selectionKey.isWritable())&#123;</span></span><br><span class="line"><span class="comment">//			SocketChannel sc = (SocketChannel) selectionKey.channel();</span></span><br><span class="line"><span class="comment">//			ByteBuffer byteBuffer = ByteBuffer.wrap("no request response".getBytes());</span></span><br><span class="line"><span class="comment">//			sc.write(byteBuffer);</span></span><br><span class="line"><span class="comment">//			selectionKey.cancel();</span></span><br><span class="line"><span class="comment">//		&#125;</span></span><br><span class="line">		it.remove();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Client端：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SocketChannel socketChannel = SocketChannel.open(<span class="keyword">new</span> InetSocketAddress(<span class="string">"127.0.0.1"</span>, <span class="number">2223</span>));</span><br><span class="line">socketChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">Selector selector = Selector.open();</span><br><span class="line">socketChannel.register(selector, SelectionKey.OP_READ|SelectionKey.OP_WRITE, <span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">boolean</span> isWrited = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">for</span>(;;)&#123;</span><br><span class="line">	<span class="keyword">int</span> num = selector.select();</span><br><span class="line">	Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();</span><br><span class="line">	Iterator&lt;SelectionKey&gt; it = selectedKeys.iterator();</span><br><span class="line">	<span class="keyword">while</span>(it.hasNext())&#123;</span><br><span class="line">		SelectionKey selectionKey = it.next();</span><br><span class="line">		it.remove();</span><br><span class="line">		<span class="keyword">if</span>(!isWrited&amp;&amp;selectionKey.isWritable())&#123;</span><br><span class="line">			ByteBuffer byteBuffer = ByteBuffer.wrap(<span class="string">"1"</span>.getBytes());</span><br><span class="line">			socketChannel.write(byteBuffer);</span><br><span class="line">			isWrited = <span class="keyword">true</span>;</span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(selectionKey.isReadable())&#123;</span><br><span class="line">			ByteBuffer byteBuffer1 = ByteBuffer.allocate(<span class="number">1024</span>);</span><br><span class="line">			<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">				byteBuffer1.clear();</span><br><span class="line">				<span class="keyword">if</span>(socketChannel.read(byteBuffer1)&lt;=<span class="number">0</span>)<span class="keyword">break</span>;</span><br><span class="line">				byteBuffer1.flip();</span><br><span class="line">				<span class="keyword">while</span>(byteBuffer1.hasRemaining())&#123;</span><br><span class="line">					System.out.print(byteBuffer1.get());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			selectionKey.cancel();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2016/01/09/Java-volatile-关键字/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2016/01/06/Nginx部署SSL证书/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"> &copy; <a href="/"> Qlm's Blog </a> 2015 
		<br><a href="http://www.miitbeian.gov.cn/" target=_blank >浙ICP备14026718号</a>
		</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> , Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a> and Run on <a target="_blank" href="http://www.aliyun.com/">Aliyun</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>






</body>
</html>
