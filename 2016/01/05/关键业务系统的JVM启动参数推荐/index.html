<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>关键业务系统的JVM启动参数推荐 | Qlm&#39;s Blog</title>
  <meta name="description" content="Java Programer" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="/css/component.css" />
  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <meta name="generator" content="Qlm's Blog">
  
  
  

  

</head>
<body>
<div class="container">
    <div class="mp-pusher" id="mp-pusher">
        <i id="scroll-up" class="fa fa-angle-up"></i>
        <nav id="mp-menu" class="mp-menu">
            <div class="mp-level">
                <a data-pjax class="back-home" style="font-size: 20px" href="/"><h2 ><i class="fa fa-home"></i>
                        Home</h2></a>
                <ul class="first-level">
                    <li>
                        <a class="fa fa-archive" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Archive</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-archive"></i>
                                Archive</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-archive" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/05/19/沉浸式状态栏解决方案/">沉浸式状态栏解决方案</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/11/常用正则表达式/">常用正则表达式</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/11/Markdown语法说明/">Markdown语法说明</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/09/数字签名/">数字签名</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/09/关于ThreadLocal对象/">关于ThreadLocal对象</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/09/Java-volatile-关键字/">Java volatile 关键字</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/08/基于NIO的Socket/">基于NIO的Socket</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/06/Nginx部署SSL证书/">Nginx部署SSL证书</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/05/关键业务系统的JVM启动参数推荐/">关键业务系统的JVM启动参数推荐</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2016/01/05/vim程序编辑器/">vim程序编辑器</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/28/使用NIO提升性能/">使用NIO提升性能</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/25/Java异常/">Java异常</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/24/JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解/">JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/24/JVM飙高排查脚本-结构分析/">JVM飙高排查脚本-结构分析</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/23/《Java并发编程实战》笔记/">《Java并发编程实战》笔记</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/22/JVM设置/">JVM设置</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/21/线程池ThreadPoolExecutor/">线程池ThreadPoolExecutor</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/21/Java并发包/">java并发包</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/21/Timer的缺陷/">Timer的缺陷</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Spring-技术内幕-IoC容器的实现/">Spring 技术内幕-IoC容器的实现</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Java-加密与解密的艺术/">Java 加密与解密的艺术</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Spring-in-action/">Spring in action</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Spring-配置头文件/">Spring 配置头文件</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/前端乱码/">前端乱码</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/能力值控制实现文档/">能力值控制实现文档</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Linux常用命令/">Linux常用命令</a>
                                </li>
                                
                                <li class="search-archive-li mp-pjax">
                                    <a href="/2015/12/17/Java开发常用Linux命令/">Java开发常用Linux命令</a>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-copy" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Categories</a>

                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-copy"></i>
                                Categories</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-category" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/其他/">&nbsp;&nbsp;&nbsp;其他</a>
                                    <small>3</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/工作/">&nbsp;&nbsp;&nbsp;工作</a>
                                    <small>2</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/开发/">&nbsp;&nbsp;&nbsp;开发</a>
                                    <small>15</small>
                                </li>
                                
                                <li class="search-category-li mp-pjax">
                                    <a href="/categories/读书/">&nbsp;&nbsp;&nbsp;读书</a>
                                    <small>7</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a class="fa fa-tags" href="#"><i class="fa fa-angle-left">
                            </i>&nbsp;&nbsp;Tags</a>
                        <div class="mp-level page-list">
                            <h2 ><i class="fa fa-tags"></i>
                                Tags</h2>
                            <a class="mp-back" href="#">back</a>
                            <form id="search-form" action="">
                                <input type="text" class="search search-tag" placeholder="Search.."/>
                            </form>
                            <ul>
                                <div class="mp-scroll">
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Android/">&nbsp;&nbsp;&nbsp;Android</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Java/">&nbsp;&nbsp;&nbsp;Java</a>
                                    <small>18</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Linux/">&nbsp;&nbsp;&nbsp;Linux</a>
                                    <small>3</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Markdown/">&nbsp;&nbsp;&nbsp;Markdown</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Nginx/">&nbsp;&nbsp;&nbsp;Nginx</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/SSL/">&nbsp;&nbsp;&nbsp;SSL</a>
                                    <small>1</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/Spring/">&nbsp;&nbsp;&nbsp;Spring</a>
                                    <small>3</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/工作/">&nbsp;&nbsp;&nbsp;工作</a>
                                    <small>2</small>
                                </li>
                                
                                <li class="search-tag-li mp-pjax">
                                    <a href="/tags/正则/">&nbsp;&nbsp;&nbsp;正则</a>
                                    <small>1</small>
                                </li>
                                
                                </div>
                            </ul>
                        </div>
                    </li>
                    
                    <!--<li class="mp-pjax"><a class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a></li>-->
                    <li><a class="fa fa-github" href="https://github.com/pqpo" target="_blank">&nbsp;&nbsp;&nbsp;Github</a></li>

                </ul>

            </div>
        </nav>
        <div id="pjax">
            <div class="pjax-hidden" style="display: none">
                
                    <a  data-pjax href="/2016/05/19/沉浸式状态栏解决方案/">沉浸式状态栏解决方案</a>
                
                    <a  data-pjax href="/2016/01/11/常用正则表达式/">常用正则表达式</a>
                
                    <a  data-pjax href="/2016/01/11/Markdown语法说明/">Markdown语法说明</a>
                
                    <a  data-pjax href="/2016/01/09/数字签名/">数字签名</a>
                
                    <a  data-pjax href="/2016/01/09/关于ThreadLocal对象/">关于ThreadLocal对象</a>
                
                    <a  data-pjax href="/2016/01/09/Java-volatile-关键字/">Java volatile 关键字</a>
                
                    <a  data-pjax href="/2016/01/08/基于NIO的Socket/">基于NIO的Socket</a>
                
                    <a  data-pjax href="/2016/01/06/Nginx部署SSL证书/">Nginx部署SSL证书</a>
                
                    <a  data-pjax href="/2016/01/05/关键业务系统的JVM启动参数推荐/">关键业务系统的JVM启动参数推荐</a>
                
                    <a  data-pjax href="/2016/01/05/vim程序编辑器/">vim程序编辑器</a>
                
                    <a  data-pjax href="/2015/12/28/使用NIO提升性能/">使用NIO提升性能</a>
                
                    <a  data-pjax href="/2015/12/25/Java异常/">Java异常</a>
                
                    <a  data-pjax href="/2015/12/24/JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解/">JVM性能调优监控工具jps、jstack、jmap、jhat、jstat、hprof使用详解</a>
                
                    <a  data-pjax href="/2015/12/24/JVM飙高排查脚本-结构分析/">JVM飙高排查脚本-结构分析</a>
                
                    <a  data-pjax href="/2015/12/23/《Java并发编程实战》笔记/">《Java并发编程实战》笔记</a>
                
                    <a  data-pjax href="/2015/12/22/JVM设置/">JVM设置</a>
                
                    <a  data-pjax href="/2015/12/21/线程池ThreadPoolExecutor/">线程池ThreadPoolExecutor</a>
                
                    <a  data-pjax href="/2015/12/21/Java并发包/">java并发包</a>
                
                    <a  data-pjax href="/2015/12/21/Timer的缺陷/">Timer的缺陷</a>
                
                    <a  data-pjax href="/2015/12/17/Spring-技术内幕-IoC容器的实现/">Spring 技术内幕-IoC容器的实现</a>
                
                    <a  data-pjax href="/2015/12/17/Java-加密与解密的艺术/">Java 加密与解密的艺术</a>
                
                    <a  data-pjax href="/2015/12/17/Spring-in-action/">Spring in action</a>
                
                    <a  data-pjax href="/2015/12/17/Spring-配置头文件/">Spring 配置头文件</a>
                
                    <a  data-pjax href="/2015/12/17/前端乱码/">前端乱码</a>
                
                    <a  data-pjax href="/2015/12/17/能力值控制实现文档/">能力值控制实现文档</a>
                
                    <a  data-pjax href="/2015/12/17/Linux常用命令/">Linux常用命令</a>
                
                    <a  data-pjax href="/2015/12/17/Java开发常用Linux命令/">Java开发常用Linux命令</a>
                
                
                    <a data-pjax href="/categories/其他/">&nbsp;&nbsp;其他</a>
                
                    <a data-pjax href="/categories/工作/">&nbsp;&nbsp;工作</a>
                
                    <a data-pjax href="/categories/开发/">&nbsp;&nbsp;开发</a>
                
                    <a data-pjax href="/categories/读书/">&nbsp;&nbsp;读书</a>
                
                
                    <a data-pjax href="/tags/Android/">&nbsp;&nbsp;Android</a>
                
                    <a data-pjax href="/tags/Java/">&nbsp;&nbsp;Java</a>
                
                    <a data-pjax href="/tags/Linux/">&nbsp;&nbsp;Linux</a>
                
                    <a data-pjax href="/tags/Markdown/">&nbsp;&nbsp;Markdown</a>
                
                    <a data-pjax href="/tags/Nginx/">&nbsp;&nbsp;Nginx</a>
                
                    <a data-pjax href="/tags/SSL/">&nbsp;&nbsp;SSL</a>
                
                    <a data-pjax href="/tags/Spring/">&nbsp;&nbsp;Spring</a>
                
                    <a data-pjax href="/tags/工作/">&nbsp;&nbsp;工作</a>
                
                    <a data-pjax href="/tags/正则/">&nbsp;&nbsp;正则</a>
                
                <a data-pjax class="fa fa-user" href="/about">&nbsp;&nbsp;&nbsp;About me</a>
            </div>
            <nav class="nexus">
                <li  style="border-left: 1px solid #c6d0da;">
                    <a id="trigger" href="#"><i class="fa fa-bars"></i></a>
                </li>
                <li ><a id="nexus-back" data-pjax href="/">Qlm&#39;s Blog</a></li>
                
            </nav>

            <div class="scroller">
            <div class="scroller-inner">


<!-- -->
<!--<body class="post-template">-->
<!---->
  

<main class="content" role="main">
    <article class="post" >
    <span class="post-meta">
                  <div class="tag-tile">
                      
                      
                      <a data-pjax href='/tags/Java/' style='color:#D5D5D5'>Java</a>
                      
                      
                  </div>
                <h1 class="post-title" style="margin: 14px 0;color:#50585D">关键业务系统的JVM启动参数推荐</h1>

                    <div class="post-meta">
                        Post on<span class="fa fa-clock-o"></span>
                        <time datetime="2016-01-05T10:27:16.000Z"
                              itemprop="datePublished">2016-01-05</time>
                    </div>
    </span>

        <section class="post-content">
            <p><a href="http://calvin1978.blogcn.com/articles/jvmoption-2.html" target="_blank" rel="external">原文地址</a></p>
<p>在关键的业务系统里，除了继续追求技术人员最爱的高吞吐与低延时之外，系统的稳定性与出现问题时排查的便捷性也很重要。</p>
<p>这是本文的一个原则，后面也会一次又一次的强调，所以与网上其他的文章略有不同，请调优高手和运维老大们多指引。</p>
<h2 id="u524D_u8A001_uFF0C_u8D44_u6599"><a href="#u524D_u8A001_uFF0C_u8D44_u6599" class="headerlink" title="前言1，资料"></a>前言1，资料</h2><p>学习开源项目的启动脚本是个不错的主意，比如Cassandra家的， 附送一篇解释它的文章。</p>
<p>JVM调优的”标准参数”的各种陷阱 R大的文章，在JDK6时写的，期待更新。</p>
<p>偶然翻到Linkedin工程师的一篇文章。</p>
<p>更偶然翻到的一份不错的参数列表。</p>
<h2 id="u524D_u8A002_uFF0C_-XX_3A+PrintFlagsFinal_u6253_u5370_u53C2_u6570_u503C"><a href="#u524D_u8A002_uFF0C_-XX_3A+PrintFlagsFinal_u6253_u5370_u53C2_u6570_u503C" class="headerlink" title="前言2， -XX:+PrintFlagsFinal打印参数值"></a>前言2， -XX:+PrintFlagsFinal打印参数值</h2><p>当你在网上兴冲冲找到一个可优化的参数时，先用-XX: +PrintFlagsFinal看看，它可能已经默认打开了，再找到一个，还是默认打开了…</p>
<p>JDK7与JDK8，甚至JDK7中的不同版本，有些参数值都不一样，所以不要轻信网上任何文章，一切以生产环境同版本的JDK打出来的为准。</p>
<p>经常以类似下面的语句去查看参数，偷懒不起应用，用-version代替。有些参数设置后会影响其他参数，所以查看时也把它带上。</p>
<p> java -server -Xmx1024m -Xms1024m -XX:+UseConcMarkSweepGC -XX:+PrintFlagsFinal -version| grep ParallelGCThreads</p>
<h2 id="u524D_u8A003_uFF0C_u5173_u4E8E_u9ED8_u8BA4_u503C"><a href="#u524D_u8A003_uFF0C_u5173_u4E8E_u9ED8_u8BA4_u503C" class="headerlink" title="前言3，关于默认值"></a>前言3，关于默认值</h2><p>JDK8会默认打开-XX:+TieredCompilation多层编译，而JDK7则不会。JDK7u40以后的版本会默认打开-XX:+OptimizeStringConcat优化字符串拼接，而之前的则不打开。</p>
<p>对于这些参数，我的建议是顺势而为，JDK在那个版本默认打开不打开总有它的理由。安全第一，没有很好的因由，不要随便因为网上某篇文章的推荐(包括你现在在读的这篇)就去设置。</p>
<ol>
<li>性能篇</li>
</ol>
<p>先写一些不那么常见的，后面再来老生常谈。</p>
<p>1.1 取消偏向锁 -XX:-UseBiasedLocking<br>JDK1.6开始默认打开的偏向锁，在没有竞争的情况下，会取消线程同步的原语，比如那个所有方法都挂着synchronized关键字的StringBuffer，如果始终只有一条线程在访问它，就略过同步操作以获得性能提升。</p>
<p>但一旦有第二个线程访问这把锁，JVM就要撤销偏向锁恢复到未锁定线程的状态，用”-XX:+PrintSafepointStatistics -XX: PrintSafepointStatisticsCount=1” 可以看到不少RevokeBiasd的纪录，像GC一样，会Stop The World的干活，虽然只是很短很短的停顿，但对于多线程并发的应用，取消掉它反而有性能的提升和延时的极微的缩短，所以Cassandra就取消了它。</p>
<p>1.2 启动时访问并置零内存页面-XX:+AlwaysPreTouch<br>启动时就把参数里说好了的内存全部舔一遍，可能令得启动时慢上一点，但后面访问时会更流畅，比如页面会连续分配，比如不会在晋升新生代到老生代时才去申请页面使得GC停顿时间加长。不过这选项对32G之类的大堆才会更有感觉一点。</p>
<p>1.3 -Djava.security.egd=file:/dev/./urandom<br>UUID.randomUUID() 有时候会很慢，Thread Dump一看居然被锁住了，原因是里面用了SecureRandom，要等待机器产生新的噪音(比如机器里的某个文件发生了变化)才肯产生新的随机数。因此最好让熵池里没有新的噪音因子时重用当前的因子。详见<br>JVM上的随机数与熵池策略</p>
<p>1.4 -XX:AutoBoxCacheMax=20000<br>Integer i = 3; 这语句有着 int自动装箱成Integer的过程，JDK默认只缓存 -128 ~ +127的int 和 long，超出范围的数字就要即时构建新的Integer对象。设为20000后，我们应用的QPS从48,000提升到50,000，足足4%的影响。详见Java Integer(-128~127)值的==和equals比较产生的思考</p>
<p>1.5 不建议的参数<br>-XX:AutoBoxCacheMax是-XX:+AggressiveOpts中的其中一项，AggressiveOpts是一些还没默认打开的优化参数集合。但如前所述，关键系统里不建议打开。虽然通过-XX:+AggressiveOpts 与 -XX:-AggressiveOpts 的对比，目前才改变了三个参数，但为免以后某个版本的JDK里默默改变更多激进的配置，还是不要了。</p>
<p>Linkined那种黑科技，先要解锁VMOptions才能配置的就更不用说了，比如</p>
<p> -XX:+UnlockDiagnosticVMOptions -XX: ParGCCardsPerStrideChunk=32768<br>同样的还有JIT Compile相关的参数，函数调用多少次之后开始编译的阀值，内联函数大小的阀值等等，不要乱改了。</p>
<p>-XX:+UseFastAccessorMethods，据说在多层编译下还慢了，所以是默认关闭的。</p>
<p>1.6 -server<br>-server 与 -client的JVM默认参数完全不一样，虽然在Linux 64位JVM里默认会被认成server模式，但还是顺手写上吧。</p>
<p>1.7 GC策略<br>为了稳健，还是CMS好了，G1的细节实现起来难度太大，从理论提出到现在都做了六七年了。</p>
<p>CMS真正可设的东西也不多，详见JVM实用参数（七）CMS收集器</p>
<p> -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly<br>因为我们的监控系统会通过JMX监控内存达到90%的状况（留点处理的时间），所以设置让它75%就开始跑了，早点开始也能避免Full GC等意外情况。为了让这个设置生效，还要设置-XX:+UseCMSInitiatingOccupancyOnly，否则75只被用来做开始的参考值，后面还是JVM自己算。</p>
<p>-XX:MaxTenuringThreshold=2，这是GC里改动效果最明显的一个参数了。对象在Survivor区熬过多少次Young GC后晋升到年老代，JDK7里看起来默认是6，跑起来好像变成了15。</p>
<p>Young GC是最大的应用停顿来源，而新生代里GC后存活对象的多少又直接影响停顿的时间，所以如果清楚Young GC的执行频率和应用里大部分临时对象的最长生命周期，可以把它设的更短一点，让其实不是临时对象的新生代长期对象赶紧晋升到年老代，别呆着。</p>
<p>用-XX:+PrintTenuringDistribution观察下，如果后面几代都差不多，就可以设小，比如JMeter里是2。而我们的两个系统里一个设了2，一个设了6。</p>
<p>-XX:+ExplicitGCInvokesConcurrent， 但不要-XX:+DisableExplicitGC， 比如Netty之堆外内存扫盲篇，可见禁了system.gc() 未必是好事，只要自己的代码里没有调它，也没用什么特别烂的类库，真有人调了总有调的原因。-XX+ExplicitGCInvokesConcurrent 则在full gc时，并不全程停顿，依然只在ygc和两个remark阶段停顿，详见JVM源码分析之SystemGC完全解读</p>
<p>-XX: ParallelRefProcEnabled , 默认为false，并行的处理Reference对象，如WeakReference，除非在GC log里出现Reference处理时间较长的日志，否则效果不会很明显，但我们总是要JVM尽量的并行，所以设了也就设了。</p>
<p>1.8 GC里不要设的参数<br>-XX:+CMSClassUnloadingEnabled，在CMS中清理永久代中的过期的Class而不等到Full GC，JDK7默认关闭而JDK8打开。看自己情况，比如有没有运行动态语言脚本如Groovy产生大量的临时类。它会增加CMS remark的暂停时间，所以如果新类加载并不频繁，这个参数还是不开的好。</p>
<p>用了CMS，新生代收集默认就是-XX:+UseParNewGC，不用自己设。</p>
<p>并发收集线程数，ParallelGCThreads＝8+( Processor - 8 ) ( 5/8 )， ConcGCThreads = (ParallelGCThreads + 3)/4，比如双CPU，六核，超线程就是24个处理器，小于8个处理器时ParallelGCThreads按处理器数量，大于时按上述公式ParallelGCThreads＝18， ConcGCThreads＝5。这线程数调整了变化也不大，还是别乱动了。</p>
<p>-XX:+CMSScavengeBeforeRemark，默认为关闭，在CMS remark前，先执行一次minor GC将新生代清掉，这样从老生代的对象引用到的新生代对象的个数就少了，停止全世界的CMS remark阶段就短一些。如果看到GC日志里remark阶段的时间超长，可以打开此项看看有没有效果，否则还是不要打开了，白白多了次GC。</p>
<p>-XX:CMSFullGCsBeforeCompaction，默认为0，即每次full gc都对老生代进行碎片整理压缩。Full GC 不同于 前面设置的75%老生代时触发的CMS GC，只在System.gc()，老生代达到100%，老生代碎片过大无法分配空间给新晋升的大对象这些特殊情况里发生，所以设为每次都进行碎片整理是合适的，详见此贴里R大的解释。</p>
<p>1.9 内存大小的设置<br>这些关于大小的参数，给人感觉是最踏实可控的。</p>
<p>其实JVM除了显式设置的-Xmx堆内存，还有一堆其他占内存的地方，在容量规划的时候要留意。</p>
<p>关键业务系统的服务器上内存一般都是够的，所以尽管设得宽松点。</p>
<p>-Xmx, -Xms, 堆内存大小，2～4G均可，再大了GC时间会拖长。</p>
<p>-Xmn or -XX:NewSize and -XX:MaxNewSize or -XX:NewRatio， JDK默认新生代占堆大小的1/3， 个人喜欢把对半分，用-Xmn 直接赋值(等于-XX:NewSize and -XX:MaxNewSize同值的缩写)，或把NewRatio设为1。 增大新生代的大小，能减少GC的频率（但也会加大每次GC的停顿时间），主要是看老生代里没多少长期对象的话，占2/3太多了。</p>
<p>-XX: PermSize=128m -XX:MaxPermSize=512m （JDK7）现在的应用有Hibernate/Spring这些闹腾的家伙AOP之后类都比较多，可以一开始就把初始值从64M设到128M，并设一个更大的Max值以求保险。</p>
<p>-XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=512m（JDK8），JDK8的永生代几乎可用完机器的所有内存，同样设一个128M的初始值，512M的最大值保护一下。</p>
<p>1.10 其他内存大小可选项</p>
<p>-XX:SurvivorRatio 新生代中每个存活区的大小，默认为8，即1/10的新生代 1/(SurvivorRatio+2)，有人喜欢设小点省点给新生代，但要避免太小使得存活区放不下临时对象而要晋升到老生代，还是从GC Log里看实际情况了。</p>
<p>-Xss 在堆之外，线程占用栈内存，默认每条线程为1M（以前是256K）。除了方法调用出参入参的栈，逃逸分析后也会把只在该线程里可见的对象直接分配在线程栈里，而不是公共的Heap里，也就减少了新生代的GC频率。有人喜欢设小点节约内存开更多线程，但反正内存够也就不必要设小，有人喜欢再设大点。</p>
<p>-XX:MaxDirectMemorySize，堆外内存/直接内存的大小，默认为Heap区总内存减去一个Survivor区的大小，详见Netty之堆外内存扫盲篇。</p>
<p>-XX:ReservedCodeCacheSize， JIT编译后二进制代码的存放区，满了之后就不再编译。JDK7默认不开多层编译48M，开了96M，而JDK8默认开多层编译256M。可以在JMX里看看CodeCache的大小，JDK7下的48M一般够了，也可以把它设大点，反正内存多。</p>
<ol>
<li>监控篇</li>
</ol>
<p>JVM输出的各种日志，如果未指定路径，通常会生成到运行应用的相同目录，为了避免有时候在不同的地方执行启动脚本，一般将日志路径集中设到一个固定的地方。</p>
<p>2.1 -XX:+PrintCommandLineFlags<br>运维有时会对启动参数做一些临时的更改，将每次启动的参数输出到stdout，将来有据可查。<br>打印出来的是命令行里设置了的参数以及因为这些参数隐式影响的参数，比如开了CMS后，-XX:+UseParNewGC也被自动打开。</p>
<p>2.2 -XX:-OmitStackTraceInFastThrow<br>为异常设置StackTrace是个昂贵的操作，所以当应用在相同地方抛出相同的异常N次(两万?)之后，JVM会对某些特定异常如NPE，数组越界等进行优化，不再带上异常栈。此时，你可能会看到日志里一条条Null Point Exception，而真正输出完整栈的日志早被滚动到不知哪里去了，也就完全不知道这NPE发生在什么地方，欲哭无泪。 所以，将它禁止吧。</p>
<p>2.3 coredump与 -XX:ErrorFile<br>JVM crash时，hotspot 会生成一个error文件，提供JVM状态信息的细节。如前所述，将其输出到固定目录，避免到时会到处找这文件。文件名中的%p会被自动替换为应用的PID</p>
<p> -XX:ErrorFile=${MYLOGDIR}/hs<em>err</em>%p.log<br>当然，更好的做法是生成coredump，从CoreDump能够转出Heap Dump 和 Thread Dump 还有crash的地方，非常实用。</p>
<p>在启动脚本里加上 ulimit -c unlimited或其他的设置方式，如果有root权限，用一下一下输出目录更好</p>
<p> echo “/{MYLOGDIR}/coredump.%p” &gt; /proc/sys/kernel/core_pattern<br>什么？你不知道这东西什么用？看来你是没遇过JVM Segment Fault的幸福人。</p>
<p>2.4 -XX:+HeapDumpOnOutOfMemoryError<br>在Out Of Memory，JVM快死快死掉的时候，输出Heap Dump到指定文件。不然开发很多时候还真不知道怎么重现错误。</p>
<p>路径只指向目录，JVM会保持文件名的唯一性，叫java_pid${pid}.hprof。如果指向文件，而文件已存在，反而不能写入。</p>
<p> -XX:+HeapDumpOnOutOfMemoryError -XX:HeapDumpPath=${LOGDIR}/</p>
<p>2.5 GC日志<br> -Xloggc:${LOGDIR}/gc-$SERVER_API.log -XX:+PrintGCDateStamps -XX:+PrintGCDetails<br>详见JVM实用参数（八）GC日志，有人担心写GC日志会影响性能，但测试下来实在没什么影响，还是留一份用来排查好。</p>
<p>另外还有一个 -XX:+PrintGCApplicationStoppedTime，它的名字没起好，它除了打印清晰的GC停顿时间外，还可以打印其他的停顿时间，比如取消偏向锁，class 被agent redefine，code deoptimization等等，有助于发现一些原来没想到的问题。</p>
<p>GC日志默认会在重启后清空，但有人担心长期运行不重启的应用会把文件弄得很大，有”-XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=10 -XX:GCLogFileSize=1M”的参数可以让日志滚动起来。但重启后的文件名太混乱太让人头痛，所以还是不加。</p>
<p>2.6 JMX<br> -Dcom.sun.management.jmxremote.port=${MY_JMX_PORT} -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false -Djava.rmi.server.hostname=127.0.0.1<br>以上设置，只让本地的Zabbix之类监控软件通过JMX监控JVM，不允许远程访问。</p>

        </section>
        <hr/>
        <nav class="pagination" style="width:auto" role="pagination">
            
            <a data-pjax class="newer-posts" href="/2016/01/06/Nginx部署SSL证书/">← Prev Post</a>
            
            <a class="share-button" data-original-title title>Share this Post</a>
            
            <a data-pjax class="older-posts" href="/2016/01/05/vim程序编辑器/">Next Post →</a>
            
        </nav>
        <br/>
        <br/>
        <section id="comment">
            <div id="comment-box"></div>
        </section>


    </article>
</main>


  
<footer class="site-footer">
    
    <div class="inner">
        <section class="copyright"> &copy; <a href="/"> Qlm's Blog </a> 2015 
		<br><a href="http://www.miitbeian.gov.cn/" target=_blank >浙ICP备14026718号</a>
		</section>
        <section class="poweredby">Published with <a target="_blank" href="http://hexo.io/">Hexo   </a> , Theme by <a target="_blank" href="https://github.com/yuche/hexo-theme-kael">Kael</a> and Run on <a target="_blank" href="http://www.aliyun.com/">Aliyun</a></section>
    </div>
</footer>
</div>
</div><!-- /scroller -->

</div><!-- /pusher -->
</div><!-- /container -->
</div>

<!-- Easter eggs -->

<div class="egg animated">
    <a id="close-button" href="#">X</a>
    <div class="block">
        <div class="loading">
            <span class="ball1"></span>
            <span class="ball2"></span>
        </div>
    </div>
</div>
  
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/lib.js"></script>
<script type="text/javascript" src="/js/main.js"></script>






</body>
</html>
